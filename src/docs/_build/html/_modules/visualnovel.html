

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>visualnovel &mdash; Renpy Interpreter 2025 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=cb975c41"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Renpy Interpreter
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Renpy Interpreter</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">visualnovel</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for visualnovel</h1><div class="highlight"><pre>
<span></span><span class="c1"># TODO: correct error in self.parse_scene (at doesnt work)</span>


<span class="c1"># MODULE that creates a visual novel game from a MasterNode AST.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Parser</span><span class="w"> </span><span class="kn">import</span> <span class="n">MasterParser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Tokens</span><span class="w"> </span><span class="kn">import</span> <span class="n">RPTokenizer</span><span class="p">,</span> <span class="n">__BREAK__TOKEN__</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">defs</span><span class="w"> </span><span class="kn">import</span> <span class="n">FILE_EOF</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">AST</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Error</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Textbox</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">defs</span><span class="w"> </span><span class="kn">import</span> <span class="n">FPS</span>

<div class="viewcode-block" id="StateMachine">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">StateMachine</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to create a visual novel video game from a dictionnary (ast tree) using the pygame library.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol_table</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">label_table</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">ast_tree</span><span class="p">,</span> <span class="n">path_to_renpyf</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_to_renpyfile</span> <span class="o">=</span> <span class="n">path_to_renpyf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol_table</span> <span class="o">=</span> <span class="n">symbol_table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_table</span> <span class="o">=</span> <span class="n">label_table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ast_tree</span> <span class="o">=</span> <span class="n">ast_tree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audio_tracking</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;voice&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sound&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span>
        <span class="p">}</span> <span class="c1"># Used by stop instruction in renpy (it&#39;s hard to keep track of the all the audio with only self.state_machine)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transition_ongoing</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Set to True whenever any transition animation if ongoing and used to prevent skipping to next self.idx until transition is finished</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># To navigate inside self.state_machine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_order_statements</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;master&#39;</span><span class="p">]</span> <span class="c1"># Contains list of all layers created from start to finish of the script</span>
         
<div class="viewcode-block" id="StateMachine.pretty_dict">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.pretty_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pretty_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">parent_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Return a formatted string representation of a nested dictionary, with indentation</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        d : The dictionary to format.</span>
<span class="sd">        parent_key (optional): The key of the parent dictionary, used to add an end-of-key comment.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str: A formatted, indented string representing the nested dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;{&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">key_str</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">nested</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretty_dict</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">parent_key</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
                <span class="n">nested</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">nested</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key_str</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">nested</span><span class="si">}</span><span class="s2">,&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key_str</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">,&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;}&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  # end of </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">parent_key</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">parent_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>


<div class="viewcode-block" id="StateMachine.get_nested_img">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.get_nested_img">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_nested_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_of_tags</span><span class="p">:</span><span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Retrieve the image path from a nested dictionary structure using a list of tags.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        list_of_tags : A list of keys representing the path through the nested dictionary.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str: The value corresponding to the final tag in the nested dictionary, typically the image path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nested_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_table</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">list_of_tags</span><span class="p">:</span>
            <span class="n">nested_dict</span> <span class="o">=</span> <span class="n">nested_dict</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">nested_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span></div>

    
<div class="viewcode-block" id="StateMachine.load_image">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.load_image">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_path</span><span class="p">):</span> <span class="c1"># Only load image we need to save some ressources</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Load an image from the specified path and return a Pygame surface with transparency.</span>
<span class="sd">        Exits the program if the image cannot be loaded.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        img_path : The relative path to the image file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pygame.Surface: A Pygame surface object containing the loaded image with transparency.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image_surface</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_to_renpyfile</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">img_path</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">image_surface</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">convert_alpha</span><span class="p">()</span>  <span class="c1"># convert_alpha() pour g√©rer la transparence</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Runtime execution error. Cannot load file </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">pygame</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">image_surface</span></div>

    
<div class="viewcode-block" id="StateMachine.get_scenenode_img">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.get_scenenode_img">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_scenenode_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Retrieve and load the image associated with a scene node.</span>
<span class="sd">        Supports both direct string paths and user-defined tokens, returning a Pygame surface.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        node : The scene node containing an image expression.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pygame.Surface: A Pygame surface object containing the loaded image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">img_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nested_img</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">image_expression</span><span class="p">)</span> <span class="c1"># Get the image to load from the tags</span>
        <span class="n">image_surface</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img_token</span><span class="p">,</span> <span class="n">StringNode</span><span class="p">):</span>
            <span class="n">img_path</span> <span class="o">=</span> <span class="n">img_token</span><span class="o">.</span><span class="n">value</span>
            <span class="n">image_surface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># img_token is expected to be a UserToken (refer to parse_image to see all the syntax handled)</span>
            <span class="n">img_path_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_value</span><span class="p">(</span><span class="n">img_token</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img_path_token</span><span class="p">,</span> <span class="n">StringNode</span><span class="p">):</span> <span class="c1"># could be a usertoken, no ?</span>
                <span class="k">raise</span> <span class="n">DetailedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runtime execution error. Expected a string but got </span><span class="si">{</span><span class="n">img_path_token</span><span class="si">}</span><span class="s2"> instead&quot;</span><span class="p">)</span>
            <span class="n">img_path</span> <span class="o">=</span> <span class="n">img_path_token</span><span class="o">.</span><span class="n">value</span>
            <span class="c1"># We need to fetch actual value of this variable (which could also be another variable...)</span>
            <span class="n">image_surface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
            <span class="c1"># print(&#39;img path = &#39;, img_path)</span>
        <span class="k">return</span> <span class="n">image_surface</span></div>

    
<div class="viewcode-block" id="StateMachine.get_position_from_size">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.get_position_from_size">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_position_from_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_size</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">screen_size</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Compute the top-left position of an object on the screen based on its size,</span>
<span class="sd">        the screen size, and a specified alignment or transformation keyword.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        obj_size : Width and height of the object (iw, ih).</span>
<span class="sd">        transform : Alignment or transformation keyword (e.g., &#39;center&#39;, &#39;topright&#39;, &#39;offscreenleft&#39;).</span>
<span class="sd">        screen_size : Width and height of the screen (sw, sh).</span>
<span class="sd">        debug : If True, prints debug information about the transform and computed position.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple of int: The (x, y) coordinates of the object&#39;s top-left corner on the screen.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sw</span><span class="p">,</span> <span class="n">sh</span> <span class="o">=</span> <span class="n">screen_size</span>
        <span class="n">iw</span><span class="p">,</span> <span class="n">ih</span> <span class="o">=</span> <span class="n">obj_size</span>  <span class="c1"># largeur/hauteur de ton &quot;objet&quot;</span>

        <span class="n">positions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;topleft&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;topright&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">sw</span> <span class="o">-</span> <span class="n">iw</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;bottomleft&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sh</span> <span class="o">-</span> <span class="n">ih</span><span class="p">),</span>
            <span class="s2">&quot;bottomright&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">sw</span> <span class="o">-</span> <span class="n">iw</span><span class="p">,</span> <span class="n">sh</span> <span class="o">-</span> <span class="n">ih</span><span class="p">),</span>
            <span class="s2">&quot;center&quot;</span><span class="p">:</span> <span class="p">((</span><span class="n">sw</span> <span class="o">-</span> <span class="n">iw</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">sh</span> <span class="o">-</span> <span class="n">ih</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">sh</span> <span class="o">-</span> <span class="n">ih</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">sw</span> <span class="o">-</span> <span class="n">iw</span><span class="p">,</span> <span class="p">(</span><span class="n">sh</span> <span class="o">-</span> <span class="n">ih</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="p">((</span><span class="n">sw</span> <span class="o">-</span> <span class="n">iw</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="p">((</span><span class="n">sw</span> <span class="o">-</span> <span class="n">iw</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sh</span> <span class="o">-</span> <span class="n">ih</span><span class="p">),</span>
            <span class="s2">&quot;offscreenleft&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">iw</span><span class="p">,</span> <span class="p">(</span><span class="n">sh</span> <span class="o">-</span> <span class="n">ih</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s2">&quot;offscreenright&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">sw</span><span class="p">,</span> <span class="p">(</span><span class="n">sh</span> <span class="o">-</span> <span class="n">ih</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;transform found: &#39;</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; and pos found: &#39;</span><span class="p">,</span> <span class="n">positions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">positions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span></div>


<div class="viewcode-block" id="StateMachine.clear_layer">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.clear_layer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer_to_clear</span><span class="p">,</span> <span class="n">chainblock</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Remove all objects from a specific layer in a Ren&#39;Py scene.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        layer_to_clear : The name of the layer to remove objects from.</span>
<span class="sd">        objects : A list of scene objects, each represented as a dictionary with potential &#39;layer&#39; keys.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of dict: The updated list with objects from the specified layer removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">chainblock</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;layer&#39;</span> <span class="ow">in</span> <span class="n">obj</span> <span class="ow">and</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">layer_to_clear</span><span class="p">:</span>
                <span class="n">chainblock</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chainblock</span></div>

        
<div class="viewcode-block" id="StateMachine.break_img_object">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.break_img_object">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">break_img_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Extract key attributes from an image object dictionary in a Ren&#39;Py scene.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        dict_ : The dictionary representing an image object with keys &#39;layer&#39;, &#39;image&#39;, &#39;pos&#39;, and &#39;transition&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple: A tuple containing (layer, image, pos, transition) extracted from the dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">dict_</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">],</span> <span class="n">dict_</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">],</span> <span class="n">dict_</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">],</span> <span class="n">dict_</span><span class="p">[</span><span class="s1">&#39;transition&#39;</span><span class="p">]</span></div>

    
<div class="viewcode-block" id="StateMachine.break_txt_object">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.break_txt_object">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">break_txt_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Extract key attributes from a text object dictionary in a Ren&#39;Py scene.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        dict_ : The dictionary representing a text object with keys &#39;character&#39; and &#39;text&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple: A tuple containing (character, text) extracted from the dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">dict_</span><span class="p">[</span><span class="s1">&#39;character&#39;</span><span class="p">],</span> <span class="n">dict_</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="n">dict_</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span></div>

    
<div class="viewcode-block" id="StateMachine.scale_image_to_wind">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.scale_image_to_wind">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">scale_image_to_wind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">window_size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Scale a Pygame image surface to fit the given window size.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        image : The image surface to scale.</span>
<span class="sd">        window_size : The target size (width, height) for scaling.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pygame.Surface: The scaled image surface.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scaled_image</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">window_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scaled_image</span></div>


<div class="viewcode-block" id="StateMachine.init_img_dict">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.init_img_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_img_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Initialize a dictionary representing a drawable image object for Pygame with default values.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict: Dictionary with default keys for image, position, layer, and transition settings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># To identify the image (only used by ShowNode)</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Either show or scene</span>
            <span class="s1">&#39;layer&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;pos&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;transition&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;animate&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># When True, we must execute the animation for a specific duration (not necessarily &#39;duration&#39; key)</span>
                <span class="s1">&#39;pos_anim&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="c1"># Used by slide type of transition, stores </span>
                <span class="s1">&#39;last_pos&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="c1"># start pos for movin transition is always the final pos of previous show statement associated with same tag</span>
                <span class="s1">&#39;elapsed&#39;</span><span class="p">:</span> <span class="mi">0</span> <span class="c1"># For linear interpolation for smooth animation in general </span>
            <span class="p">}</span>
        <span class="p">}</span></div>

    
<div class="viewcode-block" id="StateMachine.init_txt_dict">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.init_txt_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_txt_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Initialize a dictionary representing a drawable dialogue object for Pygame with default values.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict: Dictionary with the content of the dialogue and the name of the character speaking.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;character&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;#000000&#39;</span><span class="p">,</span> <span class="c1"># Default color is Black</span>
            <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span></div>

    
<div class="viewcode-block" id="StateMachine.init_audio_dict">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.init_audio_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_audio_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Initialize a dictionary representing an audio object for Pygame with default values.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict: Dictionary with the content of the audio object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;music&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># play only once by default, loop attribute can make it play indefinitely.</span>
                <span class="s1">&#39;canal&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># If False, the music is not playing currently</span>
                <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;loop&#39;</span><span class="p">:</span> <span class="kc">False</span> <span class="c1"># By default we de not loop the music</span>
            <span class="p">},</span> 
            <span class="s1">&#39;sound&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># stops automatically when next dialogue is loaded (user clicked to display the next scene). Never loops.</span>
                <span class="s1">&#39;canal&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># If False, the sound is not playing currently</span>
                <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span>
            <span class="p">},</span> 
            <span class="s1">&#39;voice&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># stops automatically when new dialogue is loaded</span>
                <span class="s1">&#39;canal&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># If False, the voice is not playing currently</span>
                <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span>
            <span class="p">}</span> 
        <span class="p">}</span></div>

                    
<div class="viewcode-block" id="StateMachine.get_label">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.get_label">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Retrieve a label node and its next label from the AST by name.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        label_name : The name of the label to search for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple: A tuple (LabelNode, next_label_name) if found, otherwise (None, None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast_tree</span><span class="p">:</span> 
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">LabelNode</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">label_name</span><span class="p">,</span> <span class="n">KeywordNode</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">label_name</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">label_name</span><span class="p">:</span>
                <span class="c1"># print(node.get_next_label())</span>
                    <span class="k">return</span> <span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">get_next_label</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">label_name</span><span class="p">,</span> <span class="n">UserNode</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">label_name</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">label_name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">get_next_label</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StateMachine.get_user_value">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.get_user_value">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_user_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_token</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Recursively resolves a user-defined token to its final value.</span>
<span class="sd">        </span>
<span class="sd">        If the token refers to another user-defined token, the method continues</span>
<span class="sd">        to follow the chain of references until a non-UserNode value is found.</span>
<span class="sd">        </span>
<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        user_token: The user-defined token to resolve.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        The final non-UserNode value associated with the user_token.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We need to keep looking until we find the actual value associated to user_token</span>
        <span class="c1"># As long as the value we find is a User token we keep searching and return the value once found</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_table</span><span class="p">[</span><span class="s1">&#39;define&#39;</span><span class="p">][</span><span class="n">user_token</span><span class="p">]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># print(&#39;token: &#39;, token)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">UserNode</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">token</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_table</span><span class="p">[</span><span class="s1">&#39;define&#39;</span><span class="p">][</span><span class="n">token</span><span class="p">]</span></div>


<div class="viewcode-block" id="StateMachine.get_labels_order">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.get_labels_order">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_labels_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Builds and returns the ordered list of label nodes to execute.</span>

<span class="sd">        Starting from the &#39;start&#39; label, this method follows each subsequent</span>
<span class="sd">        label reference (via jump instruction in renpy) to determine</span>
<span class="sd">        the execution sequence of labels.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list: Ordered list of label nodes representing execution flow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># returns list of labels to execute in order</span>
        <span class="n">label_order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">label_order_name</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
        <span class="n">jump</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># contains next label name</span>
        <span class="n">label_node</span><span class="p">,</span> <span class="n">next_label_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_label</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="n">next_label_name</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">label_node</span><span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_node</span><span class="p">)</span>
            <span class="n">label_order_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_label_name</span><span class="p">)</span>
            <span class="n">label_node</span><span class="p">,</span> <span class="n">next_label_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_label</span><span class="p">(</span><span class="n">next_label_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">label_node</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_node</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">label_order</span></div>


<div class="viewcode-block" id="StateMachine.remove_img_obj">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.remove_img_obj">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_img_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">chainblock</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Removes an image object from a given chainblock by its tag.</span>

<span class="sd">        Searches through the chainblock for an object with the specified tag,</span>
<span class="sd">        removes it if found, and returns the updated chainblock along with</span>
<span class="sd">        the position of the removed object.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        tag: The tag identifying the image object to remove.</span>
<span class="sd">        chainblock: The list of objects currently in the chainblock.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple: (updated_chainblock, obj_pos)</span>
<span class="sd">            - updated_chainblock: The chainblock after removal.</span>
<span class="sd">            - obj_pos: The position of the removed object, or (0, 0) if not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj_pos</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># contains position of object below</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">chainblock</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;tag&#39;</span> <span class="ow">in</span> <span class="n">obj</span> <span class="ow">and</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tag</span><span class="p">:</span>
                <span class="c1"># print(&#39;obj tag found = &#39;, obj)</span>
                <span class="n">obj_pos</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
                <span class="n">chainblock</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chainblock</span><span class="p">,</span> <span class="n">obj_pos</span></div>


<div class="viewcode-block" id="StateMachine.pretty_list">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.pretty_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pretty_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">liste</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Displays the contents of a list in a formatted and readable way.</span>

<span class="sd">        Each element is printed with an index label for clarity,</span>
<span class="sd">        enclosed between &quot;BEGIN DISPLAYING&quot; and &quot;END DISPLAYING&quot; markers.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        liste: The list to display.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">BEGIN DISPLAYING ###########:&#39;</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">liste</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Elem </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">#&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">elem</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;END DISPLAYING ###########:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="StateMachine.remove_text_chainblock">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.remove_text_chainblock">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_text_chainblock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chainblock</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Removes all text-related objects from the given chainblock.</span>

<span class="sd">        Iterates through the chainblock and removes any element </span>
<span class="sd">        containing the key &#39;text&#39;.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        chainblock: List of scene objects.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list: The updated chainblock with text objects removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">chainblock</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;text&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                <span class="n">chainblock</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chainblock</span></div>


<div class="viewcode-block" id="StateMachine.isolate_chainblock_state">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.isolate_chainblock_state">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">isolate_chainblock_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chainblock</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Creates a deep, isolated copy of the given chainblock to prevent shared references.</span>

<span class="sd">        Explanation:</span>
<span class="sd">            When assigning `self.state_machine[self.idx] = chainblock`, Python only stores</span>
<span class="sd">            a reference to the same list. Any later modification to `chainblock` will </span>
<span class="sd">            automatically affect previously stored states in `self.state_machine`.</span>

<span class="sd">            This method ensures each saved state is independent by manually copying </span>
<span class="sd">            each element and duplicating non-serializable objects such as Pygame Surfaces.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        chainblock: List of scene objects representing the current visual/audio state.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list: A new list containing deep copies of all objects in the chainblock.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">isolated</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">chainblock</span><span class="p">:</span>
            <span class="c1"># Superficial copy of the dictionary</span>
            <span class="n">new_elem</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># If the element contains a Pygame Surface, we create a true independent copy.</span>
            <span class="k">if</span> <span class="s1">&#39;image&#39;</span> <span class="ow">in</span> <span class="n">elem</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">],</span> <span class="n">pygame</span><span class="o">.</span><span class="n">Surface</span><span class="p">):</span>
                <span class="n">new_elem</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Copie ind√©pendante en VRAM</span>

            <span class="k">if</span> <span class="s1">&#39;sfx&#39;</span> <span class="ow">in</span> <span class="n">elem</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="s1">&#39;sfx&#39;</span><span class="p">],</span> <span class="n">pygame</span><span class="o">.</span><span class="n">Surface</span><span class="p">):</span> <span class="c1"># For music, sound et voice</span>
                <span class="n">new_elem</span><span class="p">[</span><span class="s1">&#39;sfx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="s1">&#39;sfx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Independent copy to VRAM</span>

            <span class="c1"># If there are any other non-serializable objects, we can handle them here.</span>
            <span class="c1"># Ex: if &#39;music&#39; in elem and hasattr(elem[&#39;music&#39;], &#39;copy&#39;): ...</span>

            <span class="n">isolated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_elem</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">isolated</span></div>

    
<div class="viewcode-block" id="StateMachine.search_tag_chainblock">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.search_tag_chainblock">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">search_tag_chainblock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">chainblock</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Checks whether a given tag exists within the chainblock.</span>

<span class="sd">        Iterates through all objects and returns True if an object contains</span>
<span class="sd">        a &#39;tag&#39; field that matches or includes the given tag.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        tag: The tag to search for.</span>
<span class="sd">        chainblock: List of objects representing the current scene state.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool: True if the tag is found in any object, otherwise False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">chainblock</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;tag&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="StateMachine.display_with_transition">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.display_with_transition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">display_with_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">surface</span><span class="p">:</span> <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="p">,</span> <span class="n">img</span><span class="p">:</span><span class="n">pygame</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">transition</span><span class="p">:</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Displays an image on the given Pygame surface with an optional transition effect.</span>

<span class="sd">        Supports multiple transition types such as fade, slide, movein, and dissolve. </span>
<span class="sd">        Each transition gradually modifies the image‚Äôs appearance or position over time </span>
<span class="sd">        according to the specified duration and animation parameters.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        surface: The surface to draw the image on.</span>
<span class="sd">        img: The image to display.</span>
<span class="sd">        pos: The target position (x, y) where the image should appear.</span>
<span class="sd">        transition: A dictionary describing the transition behavior.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict: Updated transition dictionary reflecting the current animation state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">transition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fade&#39;</span><span class="p">:</span>
                <span class="c1"># Beginning / continuing transition</span>
                <span class="n">alpha_value</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_alpha</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;animate&#39;</span><span class="p">]:</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">transition_ongoing</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">img</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;animate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Begin animation</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">alpha_value</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">:</span>
                        <span class="n">incr</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">/</span> <span class="p">(</span><span class="n">FPS</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">transition</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]))</span>
                        <span class="n">speed_factor</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># to match actual duration in transition[&#39;duration&#39;]</span>
                        <span class="n">incr</span> <span class="o">=</span> <span class="n">incr</span> <span class="o">*</span> <span class="n">speed_factor</span>
                        <span class="n">img</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="n">alpha_value</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">incr</span><span class="p">))</span> 
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">transition_ongoing</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span> <span class="c1"># We only do the animation once when going forward (rollback animation is not permitted)</span>

            <span class="k">elif</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;slide&#39;</span> <span class="ow">or</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;slideright&#39;</span><span class="p">:</span>
                <span class="c1"># Slide from right to desired position</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;animate&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">transition_ongoing</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">start_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_position_from_size</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get_size</span><span class="p">(),</span> <span class="s1">&#39;offscreenright&#39;</span><span class="p">,</span> <span class="n">surface</span><span class="o">.</span><span class="n">get_size</span><span class="p">())</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;pos_anim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># store fixed start x</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;animate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Begin animation</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Increment the elapsed time</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">FPS</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">transition</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># normalized 0..1</span>

                    <span class="c1"># Smooth ease-out</span>
                    <span class="n">t_smooth</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

                    <span class="c1"># Interpolate using fixed start position</span>
                    <span class="n">start_x</span> <span class="o">=</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">]</span>
                    <span class="n">end_x</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">new_x</span> <span class="o">=</span> <span class="n">start_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">end_x</span> <span class="o">-</span> <span class="n">start_x</span><span class="p">)</span> <span class="o">*</span> <span class="n">t_smooth</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;pos_anim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_x</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="c1"># Check if animation is complete</span>
                    <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">transition_ongoing</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
                        <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;pos_anim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>  <span class="c1"># snap exactly to final position</span>

                <span class="n">surface</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;pos_anim&#39;</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">transition</span>

            <span class="k">elif</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;slideleft&#39;</span><span class="p">:</span>
                <span class="c1"># Slide from left to desired position</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;animate&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">transition_ongoing</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">start_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_position_from_size</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get_size</span><span class="p">(),</span> <span class="s1">&#39;offscreenleft&#39;</span><span class="p">,</span> <span class="n">surface</span><span class="o">.</span><span class="n">get_size</span><span class="p">())</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;pos_anim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># store fixed start x</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;animate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Begin animation</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Increment the elapsed time</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">FPS</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">transition</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># normalized 0..1</span>

                    <span class="c1"># Smooth ease-out</span>
                    <span class="n">t_smooth</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

                    <span class="c1"># Interpolate using fixed start position</span>
                    <span class="n">start_x</span> <span class="o">=</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">]</span>
                    <span class="n">end_x</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">new_x</span> <span class="o">=</span> <span class="n">start_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">end_x</span> <span class="o">-</span> <span class="n">start_x</span><span class="p">)</span> <span class="o">*</span> <span class="n">t_smooth</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;pos_anim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_x</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="c1"># Check if animation is complete</span>
                    <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">transition_ongoing</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
                        <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;pos_anim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>  <span class="c1"># snap exactly to final position</span>

                <span class="n">surface</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;pos_anim&#39;</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">transition</span>

            <span class="k">elif</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;movein&#39;</span> <span class="ow">and</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;last_pos&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
                <span class="c1"># Slide from last known position to desired position</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;animate&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">transition_ongoing</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;pos_anim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;last_pos&#39;</span><span class="p">]</span>  <span class="c1"># start pos</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;last_pos&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># store fixed start x</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;animate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># begin animation</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Increment elapsed time</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">FPS</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">transition</span><span class="p">[</span><span class="s1">&#39;elapsed&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># normalized 0..1</span>

                    <span class="c1"># Smooth ease-out interpolation</span>
                    <span class="n">t_smooth</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

                    <span class="c1"># Compute new position</span>
                    <span class="n">start_x</span> <span class="o">=</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">]</span>
                    <span class="n">end_x</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">new_x</span> <span class="o">=</span> <span class="n">start_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">end_x</span> <span class="o">-</span> <span class="n">start_x</span><span class="p">)</span> <span class="o">*</span> <span class="n">t_smooth</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;pos_anim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_x</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="c1"># Check if animation is complete</span>
                    <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">transition_ongoing</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
                        <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;pos_anim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>  <span class="c1"># snap exactly to final position</span>

                <span class="n">surface</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;pos_anim&#39;</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">transition</span>
             
            <span class="k">elif</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;dissolve&#39;</span><span class="p">:</span> 
                <span class="c1"># Dissolve = fade between invisible and visible (similar to fade)</span>
                <span class="n">alpha_value</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_alpha</span><span class="p">()</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;animate&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">transition_ongoing</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">img</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;animate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Begin animation</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">alpha_value</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">:</span>
                        <span class="n">incr</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">/</span> <span class="p">(</span><span class="n">FPS</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">transition</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]))</span>
                        <span class="n">speed_factor</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># to match actual duration in transition[&#39;duration&#39;]</span>
                        <span class="n">incr</span> <span class="o">=</span> <span class="n">incr</span> <span class="o">*</span> <span class="n">speed_factor</span>
                        <span class="n">img</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="n">alpha_value</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">incr</span><span class="p">))</span>  <span class="c1"># to make the animation fluid and progressive</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">transition_ongoing</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>  <span class="c1"># animation is finished</span>

        <span class="n">surface</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">transition</span></div>

        
<div class="viewcode-block" id="StateMachine.load_audio">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.load_audio">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_audio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">audio_path</span><span class="p">,</span> <span class="n">use_canal</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Load an audio from the specified path and return a Pygame sound object.</span>
<span class="sd">        Exits the program if the audio cannot be loaded.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        audio_path : The relative path to the audio file.</span>
<span class="sd">        use_canal: Decides whether we use pygame.mixer.sound or pygame.mixer.music to load audio</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pygame.mixer.Sound: A Pygame sound object containing the loaded audio.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">canal</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_to_renpyfile</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">audio_path</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_canal</span><span class="p">:</span>
                <span class="n">canal</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">mixer</span><span class="o">.</span><span class="n">Sound</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pygame</span><span class="o">.</span><span class="n">mixer</span><span class="o">.</span><span class="n">music</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="c1"># returns None</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Runtime execution error. Cannot load audio file </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">pygame</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">canal</span></div>

    
<div class="viewcode-block" id="StateMachine.handle_audio">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.handle_audio">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_audio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">audio</span><span class="p">:</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Manages audio playback and stopping audio (music, voice, sound).</span>
<span class="sd">        </span>
<span class="sd">        Plays music, sound, or voice based on the given dictionary. Stops all audio or specific channels </span>
<span class="sd">        (music, voice, sound) with optional fadeout. </span>

<span class="sd">        fadein when music|sound|voice starts is not handled.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        audio: Dictionary containing information regarding &#39;music&#39;, &#39;voice&#39;, &#39;sound&#39;, &#39;stop&#39; renpy instructions.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We are not handling the fadein for sound or voice</span>
        <span class="k">if</span> <span class="s1">&#39;music&#39;</span> <span class="ow">in</span> <span class="n">audio</span> <span class="ow">or</span> <span class="s1">&#39;sound&#39;</span> <span class="ow">in</span> <span class="n">audio</span> <span class="ow">or</span> <span class="s1">&#39;voice&#39;</span> <span class="ow">in</span> <span class="n">audio</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">audio</span><span class="p">[</span><span class="s1">&#39;music&#39;</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">audio</span><span class="p">[</span><span class="s1">&#39;music&#39;</span><span class="p">][</span><span class="s1">&#39;canal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">load_audio</span><span class="p">(</span><span class="n">audio</span><span class="p">[</span><span class="s1">&#39;music&#39;</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">],</span> <span class="n">use_canal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">pygame</span><span class="o">.</span><span class="n">mixer</span><span class="o">.</span><span class="n">music</span><span class="o">.</span><span class="n">set_volume</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># 10% du volume maximum</span>
                    <span class="n">audio</span><span class="p">[</span><span class="s1">&#39;music&#39;</span><span class="p">][</span><span class="s1">&#39;canal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">audio</span><span class="p">[</span><span class="s1">&#39;music&#39;</span><span class="p">][</span><span class="s1">&#39;loop&#39;</span><span class="p">]:</span>
                        <span class="n">pygame</span><span class="o">.</span><span class="n">mixer</span><span class="o">.</span><span class="n">music</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">loops</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># We play it in loops</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pygame</span><span class="o">.</span><span class="n">mixer</span><span class="o">.</span><span class="n">music</span><span class="o">.</span><span class="n">play</span><span class="p">()</span> <span class="c1"># We play it once only</span>

            <span class="k">elif</span> <span class="n">audio</span><span class="p">[</span><span class="s1">&#39;voice&#39;</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">audio</span><span class="p">[</span><span class="s1">&#39;voice&#39;</span><span class="p">][</span><span class="s1">&#39;canal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="c1"># load audio</span>
                    <span class="n">audio</span><span class="p">[</span><span class="s1">&#39;voice&#39;</span><span class="p">][</span><span class="s1">&#39;canal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_audio</span><span class="p">(</span><span class="n">audio</span><span class="p">[</span><span class="s1">&#39;voice&#39;</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">])</span> <span class="c1"># We use Sound because we can create multiple canals, it&#39;s easier to handle compared to music</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">audio_tracking</span><span class="p">[</span><span class="s1">&#39;voice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">audio</span><span class="p">[</span><span class="s1">&#39;voice&#39;</span><span class="p">][</span><span class="s1">&#39;canal&#39;</span><span class="p">]</span>
                    <span class="n">audio</span><span class="p">[</span><span class="s1">&#39;voice&#39;</span><span class="p">][</span><span class="s1">&#39;canal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">play</span><span class="p">()</span>  <span class="c1"># We play it once only</span>

            <span class="k">elif</span> <span class="n">audio</span><span class="p">[</span><span class="s1">&#39;sound&#39;</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">audio</span><span class="p">[</span><span class="s1">&#39;sound&#39;</span><span class="p">][</span><span class="s1">&#39;canal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="c1"># load audio</span>
                    <span class="n">audio</span><span class="p">[</span><span class="s1">&#39;sound&#39;</span><span class="p">][</span><span class="s1">&#39;canal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_audio</span><span class="p">(</span><span class="n">audio</span><span class="p">[</span><span class="s1">&#39;sound&#39;</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">])</span> <span class="c1"># We use Sound because we can create multiple canals, it&#39;s easier to handle compared to music</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">audio_tracking</span><span class="p">[</span><span class="s1">&#39;sound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">audio</span><span class="p">[</span><span class="s1">&#39;sound&#39;</span><span class="p">][</span><span class="s1">&#39;canal&#39;</span><span class="p">]</span>
                    <span class="n">audio</span><span class="p">[</span><span class="s1">&#39;sound&#39;</span><span class="p">][</span><span class="s1">&#39;canal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">play</span><span class="p">()</span>  <span class="c1"># We play it once only</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1"># Stop</span>
            <span class="k">if</span> <span class="n">audio</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="c1"># scenario 1: &#39;stop&#39;</span>
                <span class="c1"># We must stop all channels (voice, music and sound)</span>
                <span class="n">pygame</span><span class="o">.</span><span class="n">mixer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="n">pygame</span><span class="o">.</span><span class="n">mixer</span><span class="o">.</span><span class="n">music</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

            <span class="c1"># scenario 2: &#39;stop music&#39; or &#39;stop sound&#39; or &#39;stop voice&#39; &lt;=&gt; &#39;stop music|sound|voice&#39; </span>
            <span class="c1"># scenario 3: &#39;stop music|sound|voice fadeout X&#39;</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># scenario 2 or scenario 3</span>
                <span class="c1"># Get specific music, sound or voice</span>
                <span class="k">if</span> <span class="n">audio</span><span class="p">[</span><span class="s1">&#39;fadeout&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># no fadeout:</span>
                    <span class="k">if</span> <span class="n">audio</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;voice&#39;</span><span class="p">,</span> <span class="s1">&#39;sound&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">audio_tracking</span><span class="p">[</span><span class="s1">&#39;sound&#39;</span><span class="p">][</span><span class="n">audio</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># music</span>
                        <span class="n">pygame</span><span class="o">.</span><span class="n">mixer</span><span class="o">.</span><span class="n">music</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fadeout_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">audio</span><span class="p">[</span><span class="s1">&#39;fadeout&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1"># in milliseconds</span>
                    <span class="k">if</span> <span class="n">audio</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;voice&#39;</span><span class="p">,</span> <span class="s1">&#39;sound&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">audio_tracking</span><span class="p">[</span><span class="n">audio</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">fadeout</span><span class="p">(</span><span class="n">fadeout_ms</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># music</span>
                        <span class="n">pygame</span><span class="o">.</span><span class="n">mixer</span><span class="o">.</span><span class="n">music</span><span class="o">.</span><span class="n">fadeout</span><span class="p">(</span><span class="n">fadeout_ms</span><span class="p">)</span></div>


<div class="viewcode-block" id="StateMachine.clear_audio">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.clear_audio">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_audio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Stops all audio playback (sound and voice) in the game.</span>

<span class="sd">        This function is intended to be called when transitioning to the next piece of dialogue. </span>
<span class="sd">        It ensures that any ongoing sound effects or voice lines are stopped automatically, </span>
<span class="sd">        without affecting the background music.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># When getting to next dialogue sound and voice must be stop automatically but not music</span>
        <span class="n">pygame</span><span class="o">.</span><span class="n">mixer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>


<div class="viewcode-block" id="StateMachine.display_state">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.display_state">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">display_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">surface</span><span class="p">,</span> <span class="n">texbox</span><span class="p">:</span> <span class="n">TextBox</span><span class="p">,</span> <span class="n">pos_textbox</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Renders the current state of the scene onto the given surface, including images and text.</span>

<span class="sd">        Images are drawn according to the layer order and with their associated transitions.</span>
<span class="sd">        Text objects are rendered using the provided TextBox at the specified position.</span>
<span class="sd">        This function is typically called once per frame in the main loop.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        surface: The surface to render the scene on.</span>
<span class="sd">        texbox: The text box object used to render dialogue text.</span>
<span class="sd">        pos_textbox: The position (x, y) to draw the text box.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This function is called at each frame of the main loop (which helps us a lot for transitions as they also must be updated at each frame)</span>
        <span class="c1"># First we display all the images with pygame:</span>
        <span class="n">chainblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">z_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_order_statements</span><span class="p">:</span> <span class="c1"># order of layers</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">chainblock</span><span class="p">:</span> <span class="c1"># obj = key </span>
                <span class="c1"># print(&#39;obj&#39;, obj)</span>
                <span class="k">if</span> <span class="s1">&#39;image&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="n">layer</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">transition_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">break_img_object</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="n">z_index</span><span class="p">:</span>
                        <span class="n">transition_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_with_transition</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">transition_dict</span><span class="p">)</span>
                        <span class="c1"># update self.state_machine with new transition status:</span>
                        <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;transition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transition_dict</span>

        <span class="c1"># raise DetailedError(&#39;debug&#39;)</span>
        <span class="c1"># Then we display the dialogue:</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">chainblock</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;text&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                <span class="n">speaker</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">break_txt_object</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="c1"># print(&#39;text = &#39;, text)</span>
                <span class="n">texbox</span><span class="o">.</span><span class="n">complex_draw</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">pos_textbox</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">speaker</span><span class="o">=</span><span class="n">speaker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                
        <span class="c1"># raise DetailedError(&#39;debug2 error raised right over there&#39;)</span>
        <span class="c1"># Then we handle the audio:</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">chainblock</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;music&#39;</span> <span class="ow">in</span> <span class="n">obj</span> <span class="ow">or</span> <span class="s1">&#39;sound&#39;</span> <span class="ow">in</span> <span class="n">obj</span> <span class="ow">or</span> <span class="s1">&#39;voice&#39;</span> <span class="ow">in</span> <span class="n">obj</span> <span class="ow">or</span> <span class="s1">&#39;stop&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_audio</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div>


<div class="viewcode-block" id="StateMachine.get_dialogue_speaker">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.get_dialogue_speaker">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_dialogue_speaker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the speaker&#39;s name from the dialogue node.</span>
<span class="sd">        </span>
<span class="sd">        Resolves the speaker to a string by checking for various types of nodes</span>
<span class="sd">        (UserNode, FunctionCallNode, StringNode). Returns the speaker&#39;s name </span>
<span class="sd">        after extracting the appropriate value.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        node: The dialogue node containing the speaker information.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str: The speaker&#39;s name as a string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">speaker</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">speaker</span>
        <span class="n">color</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">speaker</span><span class="p">,</span> <span class="n">UserNode</span><span class="p">):</span>
            <span class="n">speaker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_value</span><span class="p">(</span><span class="n">speaker</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">speaker</span><span class="p">,</span> <span class="n">FunctionCallNode</span><span class="p">):</span>
            <span class="n">speaker</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">speaker</span><span class="o">.</span><span class="n">get_character_name</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">speaker</span><span class="p">,</span> <span class="n">UserNode</span><span class="p">):</span>
                <span class="n">speaker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_value</span><span class="p">(</span><span class="n">speaker</span><span class="p">)</span>             

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">speaker</span><span class="p">,</span> <span class="n">StringNode</span><span class="p">):</span>
            <span class="n">speaker</span> <span class="o">=</span> <span class="n">speaker</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">speaker</span><span class="p">,</span> <span class="n">color</span> <span class="c1"># Here, speaker is not a UserNode</span></div>

        
<div class="viewcode-block" id="StateMachine.create_state_machine">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.create_state_machine">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_state_machine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">screen_size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Creates a state machine that processes labels, dialogue, and scene nodes, </span>
<span class="sd">        then organizes and prepares data for rendering in the game.</span>

<span class="sd">        This function iterates through the labels, processes different node types (such as dialogue, scene, and show),</span>
<span class="sd">        and constructs a list of actions (`chainblock`) that will be executed sequentially. Each action (such as </span>
<span class="sd">        displaying text or images) is associated with transitions, transformations, and layers to control how they </span>
<span class="sd">        are rendered during gameplay.</span>

<span class="sd">        It also handles scaling of images and checks if a tag (for images) already exists to avoid duplicates.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        screen_size : The size of the screen (width, height) to adjust image sizes and positions accordingly.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            The state machine is constructed in place and does not return any value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labels_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_labels_order</span><span class="p">()</span>
        <span class="n">chainblock</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># list of pygame commands to show between two user actions </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">label_body</span> <span class="ow">in</span> <span class="n">labels_order</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">label_body</span><span class="p">:</span>
                <span class="c1"># print(&#39;node = &#39;, node)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">StringNode</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">DialogueNode</span><span class="p">):</span>
                    <span class="n">txt_display</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_txt_dict</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">DialogueNode</span><span class="p">):</span>
                        <span class="n">speaker</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dialogue_speaker</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                        <span class="n">txt_display</span><span class="p">[</span><span class="s1">&#39;character&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">speaker</span>
                        <span class="n">txt_display</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">txt_display</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># It&#39;s a string </span>
                        <span class="n">txt_display</span><span class="p">[</span><span class="s1">&#39;character&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">txt_display</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                    <span class="c1"># print(&#39;name = &#39;, txt_display[&#39;text&#39;])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_text_chainblock</span><span class="p">(</span><span class="n">chainblock</span><span class="p">)</span> <span class="c1"># We keep the images (scene and show but we remove the text)</span>

                    <span class="n">chainblock</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">txt_display</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolate_chainblock_state</span><span class="p">(</span><span class="n">chainblock</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">PlayNode</span><span class="p">):</span>
                    <span class="c1"># We should play either a background music, character&#39;s voice or a sound (SFX)</span>
                    <span class="n">audio_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_audio_dict</span><span class="p">()</span>
                    <span class="n">audio_value</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">audio_file</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">audio_value</span><span class="p">,</span> <span class="n">UserNode</span><span class="p">):</span>
                        <span class="n">audio_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_value</span><span class="p">(</span><span class="n">audio_value</span><span class="p">)</span>
                    <span class="c1"># At this point audio_value is a StringNode necessarily</span>
                    <span class="n">audio_value</span> <span class="o">=</span> <span class="n">audio_value</span><span class="o">.</span><span class="n">value</span>

                    <span class="c1"># print(&#39;audio_value = &#39;, audio_value)</span>

                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">audio_type</span> <span class="o">==</span> <span class="s1">&#39;music&#39;</span><span class="p">:</span>
                        <span class="n">audio_obj</span><span class="p">[</span><span class="s1">&#39;music&#39;</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">audio_value</span>
                        <span class="n">audio_obj</span><span class="p">[</span><span class="s1">&#39;music&#39;</span><span class="p">][</span><span class="s1">&#39;loop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">loop</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">audio_obj</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">audio_type</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">audio_value</span>

                    <span class="n">chainblock</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">audio_obj</span><span class="p">)</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">StopNode</span><span class="p">):</span>
                    <span class="n">audio_value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">audio_fadeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">audio_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">audio_value</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">audio_type</span> <span class="c1"># audio_value must be a KeywordNode</span>

                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">fadeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">audio_fadeout</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">fadeout</span>

                    <span class="n">stop_obj</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">audio_value</span><span class="p">,</span>
                        <span class="s1">&#39;fadeout&#39;</span><span class="p">:</span> <span class="n">audio_fadeout</span>
                    <span class="p">}</span>

                    <span class="n">chainblock</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stop_obj</span><span class="p">)</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">SceneNode</span><span class="p">):</span>
                    <span class="n">img_display</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_img_dict</span><span class="p">()</span>
                    <span class="n">image_surface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scenenode_img</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">image_surface</span><span class="o">.</span><span class="n">get_size</span><span class="p">()</span> <span class="o">!=</span> <span class="n">screen_size</span><span class="p">:</span> <span class="c1"># we do this only because it&#39;s a background ----&gt;&gt;&gt; NEED TO BE AN OPTION IN GUI WIND LATER</span>
                        <span class="n">testing_scale</span> <span class="o">=</span> <span class="n">screen_size</span> 
                        <span class="n">image_surface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_image_to_wind</span><span class="p">(</span><span class="n">image_surface</span><span class="p">,</span> <span class="n">testing_scale</span><span class="p">)</span>

                    <span class="n">transform</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">transform_name</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;topleft&#39;</span>
                    <span class="n">transition</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">transition</span><span class="o">.</span><span class="n">transition</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">transition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;none&#39;</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span> <span class="n">LayerNode</span><span class="p">):</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">layer_name</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;master&#39;</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># node.layer must be a UserNode</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;master&#39;</span>

                    <span class="n">img_display</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;scene&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">SceneNode</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;scene&#39;</span>
                    <span class="n">img_display</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_surface</span>
                    <span class="n">img_display</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_position_from_size</span><span class="p">(</span><span class="n">image_surface</span><span class="o">.</span><span class="n">get_size</span><span class="p">(),</span> <span class="n">transform</span><span class="p">,</span> <span class="n">screen_size</span><span class="p">)</span>
                    <span class="n">img_display</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer</span>
                    <span class="n">img_display</span><span class="p">[</span><span class="s1">&#39;transition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">transition</span><span class="p">,</span>
                        <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="c1"># default duration in second (we don&#39;t handle custom transition so it&#39;s always 1 sec)</span>
                        <span class="s1">&#39;animate&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s1">&#39;pos_anim&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="p">}</span>
                    
                    <span class="c1"># Before updating chainblock we check if layer already exist or not:</span>
                    <span class="k">if</span> <span class="n">layer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_order_statements</span><span class="p">:</span> <span class="c1"># to keep a trace of order of inline-declaration of layers</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">layer_order_statements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># layer already exist: we must clear all image on the current layer</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">clear_layer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">chainblock</span><span class="p">)</span>

                    <span class="n">chainblock</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_display</span><span class="p">)</span>

                    <span class="c1"># print()</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ShowNode</span><span class="p">):</span>
                    <span class="n">img_display</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_img_dict</span><span class="p">()</span>
                    <span class="n">image_surface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scenenode_img</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">image_surface</span><span class="o">.</span><span class="n">get_size</span><span class="p">()</span> <span class="o">!=</span> <span class="n">screen_size</span><span class="p">:</span> <span class="c1"># we do this only because it&#39;s a background ----&gt;&gt;&gt; NEED TO BE AN OPTION IN GUI WIND LATER</span>
                        <span class="n">image_surface</span> <span class="o">=</span> <span class="n">scale_img</span><span class="p">(</span><span class="n">image_surface</span><span class="p">,</span> <span class="n">desired_width</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

                    <span class="n">transform</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">transform_name</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;center&#39;</span>
                    <span class="n">transition</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">transition</span><span class="o">.</span><span class="n">transition</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">transition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;none&#39;</span>
                    <span class="n">tag</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">image_expression</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># first elem only</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span> <span class="n">LayerNode</span><span class="p">):</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">layer_name</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;master&#39;</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># node.layer must be a UserNode</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;master&#39;</span>

                    <span class="n">img_display</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;show&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ShowNode</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;show&#39;</span>
                    <span class="n">img_display</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_surface</span>
                    <span class="n">img_display</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_position_from_size</span><span class="p">(</span><span class="n">image_surface</span><span class="o">.</span><span class="n">get_size</span><span class="p">(),</span> <span class="n">transform</span><span class="p">,</span> <span class="n">screen_size</span><span class="p">)</span>
                    <span class="n">img_display</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer</span>
                    <span class="n">img_display</span><span class="p">[</span><span class="s1">&#39;transition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">transition</span><span class="p">,</span>
                        <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="c1"># default duration in second (we don&#39;t handle custom transition so it&#39;s always 1 sec)</span>
                        <span class="s1">&#39;animate&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s1">&#39;pos_anim&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="c1"># Cannot be None to prevent error in display_with_transition</span>
                        <span class="s1">&#39;last_pos&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># This is to prevent from wrong usage of movein (ex: if we use a movein transition on the first show statement of the game)</span>
                        <span class="s1">&#39;elapsed&#39;</span><span class="p">:</span> <span class="mi">0</span> <span class="c1"># for linear interpolation</span>
                    <span class="p">}</span>
                    <span class="n">img_display</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span>

                    <span class="c1"># Before updating chainblock we check if layer already exist or not:</span>
                    <span class="k">if</span> <span class="n">layer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_order_statements</span><span class="p">:</span> <span class="c1"># to keep a trace of order of inline-declaration of layers</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">layer_order_statements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

                    <span class="c1"># Checking if tag already exist and is used                </span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_tag_chainblock</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">chainblock</span><span class="p">):</span> <span class="c1"># Already exist, image must be cleared</span>
                        <span class="n">chainblock</span><span class="p">,</span> <span class="n">last_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_img_obj</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">chainblock</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">img_display</span><span class="p">[</span><span class="s1">&#39;transition&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;movein&#39;</span> <span class="ow">and</span> <span class="n">last_pos</span> <span class="o">!=</span> <span class="n">img_display</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]:</span> <span class="c1"># only useful for movein transition</span>
                            <span class="c1"># If img_display[&#39;transition&#39;][&#39;pos&#39;] == last_pos there is no point to the movein animation transition</span>
                            <span class="n">img_display</span><span class="p">[</span><span class="s1">&#39;transition&#39;</span><span class="p">][</span><span class="s1">&#39;last_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_pos</span>
                        <span class="c1"># print(&#39;removed: &#39;, tag)</span>

                    <span class="n">chainblock</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_display</span><span class="p">)</span></div>

       
<div class="viewcode-block" id="StateMachine.generate_VN">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.StateMachine.generate_VN">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_VN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Initializes and runs the visual novel game loop using Pygame, displaying nodes and transitions.</span>

<span class="sd">        This function sets up the Pygame window, initializes the state machine, and handles user input</span>
<span class="sd">        to navigate through the game states (represented by the `state_machine`). It processes `KEYDOWN`</span>
<span class="sd">        events for left and right arrow keys to navigate through the visual novel, updates the screen based</span>
<span class="sd">        on the current state, and handles transitions between game elements (such as text and images).</span>

<span class="sd">        It also displays a gradient textbox at the bottom of the screen and updates the display each frame.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            This function runs an interactive loop, updating the display and responding to user input in real-time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pygame</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="n">pygame</span><span class="o">.</span><span class="n">mixer</span><span class="o">.</span><span class="n">init</span><span class="p">()</span> <span class="c1"># for music</span>
        <span class="n">WIDTH</span> <span class="o">=</span> <span class="mi">1200</span>
        <span class="n">HEIGHT</span> <span class="o">=</span> <span class="mi">800</span>
        <span class="n">screen_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">WIDTH</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">)</span> <span class="c1"># sw, sh (WINDOW size)</span>
        <span class="n">screen</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="n">screen_size</span><span class="p">)</span> 
        <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">set_caption</span><span class="p">(</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
        <span class="n">clock</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Clock</span><span class="p">()</span>

        <span class="c1"># pygame.mixer.music.load(&quot;Tests-RenPy-Scripts\Execution-scripts\musics-test\E.S-Posthumus-Unstoppable.mp3&quot;)</span>
        <span class="c1"># pygame.mixer.music.play()</span>

        <span class="c1"># Textbox and gradient:</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">173</span><span class="p">,</span> <span class="mi">216</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">240</span><span class="p">)</span>  <span class="c1"># Light blue</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">135</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>  <span class="c1"># Sky blue</span>
        <span class="n">gradient</span> <span class="o">=</span>  <span class="n">Gradient</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>  
        <span class="n">container_surface</span> <span class="o">=</span> <span class="n">TextBox</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">gr</span><span class="o">=</span><span class="n">gradient</span><span class="p">)</span>
        <span class="n">container_surface</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">offset_x</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">offset_y</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">gr</span><span class="o">=</span><span class="n">gradient</span><span class="p">,</span> <span class="n">flip_gradient</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>        

        <span class="bp">self</span><span class="o">.</span><span class="n">create_state_machine</span><span class="p">(</span><span class="n">screen_size</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">########### DEBUGGING VISUAL NOVEL BEGIN ##################</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;current chainblock: &quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretty_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>  
        <span class="n">pos_textbox</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">HEIGHT</span> <span class="o">-</span> <span class="mi">200</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">running</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">pygame</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">QUIT</span><span class="p">:</span>
                    <span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">KEYDOWN</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">K_RIGHT</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pressed key right&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">transition_ongoing</span><span class="p">:</span> <span class="c1"># We wait for transition to finish</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">clear_audio</span><span class="p">()</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;current chainblock: &quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">pretty_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;transition ongoing - cannot pass to next state&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">K_LEFT</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>                                
                            <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">-=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pressed key left&#39;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;current chainblock: &quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">pretty_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>

            <span class="n">screen</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_color</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_state</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">container_surface</span><span class="p">,</span> <span class="n">pos_textbox</span><span class="p">)</span>
            <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">flip</span><span class="p">()</span>
            <span class="n">clock</span><span class="o">.</span><span class="n">tick</span><span class="p">(</span><span class="n">FPS</span><span class="p">)</span>  
            <span class="c1"># break</span>

        <span class="n">pygame</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>   </div>
</div>

    
<div class="viewcode-block" id="VisualNovelGenerator">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.VisualNovelGenerator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">VisualNovelGenerator</span><span class="p">():</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">renpy_file</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug_PATH</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="c1"># Init the game:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_to_renpyfile</span> <span class="o">=</span> <span class="n">renpy_file</span> <span class="c1"># Used much later (during runtime execution)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tk</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Tokenizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ast_tree</span> <span class="o">=</span> <span class="kc">None</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Dictionnary initialise during Initialisation Phase (contains all top level ASTnode)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels_table</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Dictionnary initialise during Initialisation Phase (contains all label nodes), key = label name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># State machine for runtime game</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_state</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># To navigate inside state_machine</span>
        
        <span class="c1"># Load all ressources:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step1_loadfile</span><span class="p">(</span><span class="n">renpy_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step2_tokenizer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step3_parser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step4_initialize_master_node</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">output_result</span><span class="p">(</span><span class="n">debug_PATH</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">step5_runtime</span><span class="p">()</span>
        
<div class="viewcode-block" id="VisualNovelGenerator.output_result">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.VisualNovelGenerator.output_result">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">output_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug_PATH</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Writes the AST, symbols table, and labels table to text files for analysis.</span>

<span class="sd">        This function outputs the following files in the `outputs_file` directory:</span>
<span class="sd">        - `output_ast.txt`: The string representation of the AST.</span>
<span class="sd">        - `symbols_table.txt`: A formatted version of the symbols table.</span>
<span class="sd">        - `labels_table.txt`: A formatted version of the labels table.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">debug_PATH</span><span class="o">+</span><span class="s2">&quot;output_ast.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="c1"># MasterNode is written in a file</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ast_tree</span><span class="p">))</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretty_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">debug_PATH</span><span class="o">+</span><span class="s2">&quot;symbols_table.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="c1"># We write all the labels in a file</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretty_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels_table</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">debug_PATH</span><span class="o">+</span><span class="s2">&quot;labels_table.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="c1"># We write all the top level definitions outisde labels in a file</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">))</span></div>

        
<div class="viewcode-block" id="VisualNovelGenerator.pretty_dict">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.VisualNovelGenerator.pretty_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pretty_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">parent_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Formats and displays a nested dictionary with indentation and end-of-key markers.</span>

<span class="sd">        This function recursively formats a dictionary into a readable string, adding </span>
<span class="sd">        indentation for nested dictionaries and appending &#39;end of &lt;key&gt;&#39; after each </span>
<span class="sd">        nested dictionary.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        d : The dictionary to format.</span>
<span class="sd">        parent_key : The key of the current level (used for the &#39;end of&#39; marker).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str: A formatted string representing the dictionary with proper indentation and end markers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;{&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">key_str</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">nested</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretty_dict</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">parent_key</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
                <span class="n">nested</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">nested</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key_str</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">nested</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key_str</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;}&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  # end of </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">parent_key</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">parent_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>


<div class="viewcode-block" id="VisualNovelGenerator.print_list_token">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.VisualNovelGenerator.print_list_token">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_list_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Formats and displays a nested dictionary with indentation and end-of-key markers.</span>

<span class="sd">        This function recursively formats a dictionary into a readable string, adding </span>
<span class="sd">        indentation for nested dictionaries and appending &#39;end of &lt;key&gt;&#39; after each </span>
<span class="sd">        nested dictionary.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        d : The dictionary to format.</span>
<span class="sd">        parent_key : The key of the current level (used for the &#39;end of&#39; marker).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            A formatted string representing the dictionary with proper indentation and end markers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_tokens</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">ligne_idx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">printed_line_num</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_tokens</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;NEWLINE&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">printed_line_num</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">ligne_idx</span><span class="si">}</span><span class="s2"> || NEWLINE&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NEWLINE&quot;</span><span class="p">)</span>
                <span class="n">ligne_idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">printed_line_num</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>

            <span class="n">e_type</span><span class="p">,</span> <span class="n">e_val</span> <span class="o">=</span> <span class="n">__BREAK__TOKEN__</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">printed_line_num</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">ligne_idx</span><span class="si">}</span><span class="s2"> || &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">printed_line_num</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">e_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;KEYWORD&#39;</span><span class="p">,</span> <span class="s1">&#39;USER&#39;</span><span class="p">,</span> <span class="s1">&#39;BUILTIN&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e_type</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">e_val</span><span class="si">}</span><span class="s2">) -&gt; &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e_type</span><span class="si">}</span><span class="s2"> -&gt; &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="VisualNovelGenerator.step1_loadfile">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.VisualNovelGenerator.step1_loadfile">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">step1_loadfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">renpy_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Loads the contents of a Ren&#39;Py script file into memory.</span>

<span class="sd">        This function opens the specified Ren&#39;Py script file, reads its contents, </span>
<span class="sd">        and stores the content in the `self.file` attribute.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        renpy_file : The path to the Ren&#39;Py script file to be loaded.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">renpy_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>


<div class="viewcode-block" id="VisualNovelGenerator.step2_tokenizer">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.VisualNovelGenerator.step2_tokenizer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">step2_tokenizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Tokenizes the loaded Ren&#39;Py script and stores the tokens found in a list.</span>

<span class="sd">        This function uses the `RPTokenizer` to tokenize the contents of the loaded </span>
<span class="sd">        Ren&#39;Py script file, storing the tokens in `self.list_tokens`. The tokenization </span>
<span class="sd">        process continues until the end of the file is reached.</span>

<span class="sd">        If debugging is enabled, it prints all the tokens found.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tk</span> <span class="o">=</span> <span class="n">RPTokenizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tk</span><span class="o">.</span><span class="n">tokenizer_from_file</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">token</span> <span class="o">!=</span> <span class="n">FILE_EOF</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tk</span><span class="o">.</span><span class="n">tokenizer_from_file</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">########### PRINTING ALL THE TOKENS FOUND ##################</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_list_token</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">########### END OF TOKENS FOUND ##################</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">()</span></div>


<div class="viewcode-block" id="VisualNovelGenerator.step3_parser">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.VisualNovelGenerator.step3_parser">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">step3_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Parses the tokenized Ren&#39;Py script into an Abstract Syntax Tree (AST).</span>

<span class="sd">        This function uses the `MasterParser` to parse the list of tokens and </span>
<span class="sd">        generates an AST representing the structure of the Ren&#39;Py script. The resulting </span>
<span class="sd">        AST is stored in `self.ast_tree`.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">MasterParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_tokens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ast_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_renpy_file</span><span class="p">()</span></div>


<div class="viewcode-block" id="VisualNovelGenerator.update_nested_table_image_node">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.VisualNovelGenerator.update_nested_table_image_node">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_nested_table_image_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">ast_node</span><span class="p">:</span> <span class="n">ImageNode</span><span class="p">,</span> <span class="n">img_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Updates a nested table with the image path from an ImageNode.</span>

<span class="sd">        This function navigates through the `table` (a nested dictionary) using the tags </span>
<span class="sd">        from the `ast_node.image_expression`, and adds or updates the image path for </span>
<span class="sd">        the final tag. If a tag already exists, the image path is updated without overwriting </span>
<span class="sd">        any existing data at higher levels in the nested structure.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        table : The nested dictionary to update with the image path.</span>
<span class="sd">        ast_node : The AST node containing the image expression and image path.</span>
<span class="sd">        img_path : The path of the image to store in the nested table.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">table</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">ast_node</span><span class="o">.</span><span class="n">image_expression</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">ast_node</span><span class="o">.</span><span class="n">image_expression</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span> 
                    <span class="n">key</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">key</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="s1">&#39;image_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_path</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># tag already exist, meaning we don&#39;t want to delete the current value of key[value]</span>
                    <span class="n">key</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="s1">&#39;image_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_path</span> <span class="c1"># We basically add another key to the dictionnary &#39;key[tag]&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span> <span class="c1"># We keep increasing the depth of our nested dictionnary</span>
                    <span class="n">key</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Necessary or the next line won&#39;t work</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="c1"># The new key is updated</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># We do not want to override an existing key</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span></div>


<div class="viewcode-block" id="VisualNovelGenerator.update_nested_table">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.VisualNovelGenerator.update_nested_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_nested_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">ast_node</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Updates a nested table with arguments from an AST node.</span>

<span class="sd">        This function navigates through the `table` (a nested dictionary) using the tags </span>
<span class="sd">        from the `ast_node.image_expression`, and adds or updates the arguments for the </span>
<span class="sd">        final tag. If a tag already exists, the arguments are updated without overwriting </span>
<span class="sd">        any existing data at higher levels in the nested structure.</span>

<span class="sd">        The difference with update_nested_table_image_node is the type of information </span>
<span class="sd">        we want to store at the end of the nested dictionnary.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        table : The nested dictionary to update with the arguments.</span>
<span class="sd">        ast_node : The AST node containing the image expression and associated data.</span>
<span class="sd">        args : A dictionary of arguments to be stored in the nested table.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">table</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">ast_node</span><span class="o">.</span><span class="n">image_expression</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">ast_node</span><span class="o">.</span><span class="n">image_expression</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span> 
                    <span class="n">key</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">key</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="s1">&#39;args&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># tag already exist, meaning we don&#39;t want to delete the current value of key[value]</span>
                    <span class="n">key</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="s1">&#39;args&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span> 
                    <span class="n">key</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># We do not want to override an existing key</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span></div>

    
<div class="viewcode-block" id="VisualNovelGenerator.verify_prior_declaration">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.VisualNovelGenerator.verify_prior_declaration">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">verify_prior_declaration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ast_node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Verifies that all variables used in the given AST node are declared beforehand.</span>

<span class="sd">        This function verifies that all variables, image tags, and functions used in the provided AST node </span>
<span class="sd">        have been declared beforehand. It checks the following types of nodes:</span>

<span class="sd">        - `DefineNode`: Ensures that any variables or functions defined within the node are previously declared in the symbol table.</span>
<span class="sd">        - `SceneNode`, `ShowNode`, and `HideNode`: Verifies that any tags (such as image tags) used in these nodes exist in the symbol table.</span>
<span class="sd">        - `TransitionNode`: Checks that the transition variable, if used, is declared.</span>
<span class="sd">        - `ReturnNode`: Verifies that any variable or function returned in the node is declared.</span>
<span class="sd">        - `JumpNode`: Ensures that the label being jumped to exists.</span>
<span class="sd">        - `DialogueNode`: Verifies that the speaker or any variables used in the dialogue have been declared.</span>

<span class="sd">        If any tag, variable, or function is used before being declared, a runtime error is raised, </span>
<span class="sd">        indicating that the user who wrote the script made a mistake.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        ast_node : The AST node to verify, which can be a `DefineNode`, `SceneNode`, `HideNode`, or `ShowNode`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Used by define node, scene node, hide node and show node and more to verify if tags used by these statement were declared or not.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">DefineNode</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">UserNode</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;define&#39;</span><span class="p">]]:</span>
                    <span class="k">raise</span> <span class="n">DetailedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Runtime error with the statement </span><span class="si">{</span><span class="n">ast_node</span><span class="si">}</span><span class="s1">. Cannot use a variable that had not been declared. Variable: </span><span class="si">{</span><span class="n">ast_node</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">FunctionCallNode</span><span class="p">):</span>
                <span class="n">user_node_list</span> <span class="o">=</span> <span class="n">ast_node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">get_user_tokens</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">user_token</span> <span class="ow">in</span> <span class="n">user_node_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_token</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;define&#39;</span><span class="p">]]:</span>
                        <span class="k">raise</span> <span class="n">DetailedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Runtime error with the statement </span><span class="si">{</span><span class="n">ast_node</span><span class="si">}</span><span class="s1">. Cannot use a variable that had not been declared. Variable: </span><span class="si">{</span><span class="n">user_token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">SceneNode</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">ShowNode</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">HideNode</span><span class="p">):</span>
            <span class="c1"># First of all, we check for image_expression:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DetailedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Runtime Error with the statement </span><span class="si">{</span><span class="n">ast_node</span><span class="si">}</span><span class="s1">. Cannot use tags </span><span class="si">{</span><span class="n">ast_node</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()</span><span class="si">}</span><span class="s1"> that are not declared.&#39;</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="c1"># key is what we already studied</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">ast_node</span><span class="o">.</span><span class="n">image_expression</span><span class="p">:</span> <span class="c1"># ast_node is what we are studying </span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> 
                <span class="k">if</span> <span class="s1">&#39;image_path&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DetailedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Runtime error with the statement </span><span class="si">{</span><span class="n">ast_node</span><span class="si">}</span><span class="s1">. Tried to use a non-existent image tag: </span><span class="si">{</span><span class="n">ast_node</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DetailedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Runtime Error with the statement </span><span class="si">{</span><span class="n">ast_node</span><span class="si">}</span><span class="s1">. Tried to use a non-existent image tag: </span><span class="si">{</span><span class="n">ast_node</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Then, we check for transition:</span>
            <span class="c1"># In this project custom transition declaration is not handled yet (define my_fade = Fade(2.0)). </span>

            <span class="c1"># Finally, we check for layer: Custom layer are not declared with &#39;define&#39; keyword, they are</span>
            <span class="c1"># declared during inline usage of SceneNode / ShowNode </span>
            <span class="c1"># or HideNode and we never raise errors for them in this project. </span>
            
    
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">TransitionNode</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">transition</span><span class="p">,</span> <span class="n">UserNode</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">transition</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;define&#39;</span><span class="p">]]:</span>
                    <span class="k">raise</span> <span class="n">DetailedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Runtime error with the statement </span><span class="si">{</span><span class="n">ast_node</span><span class="si">}</span><span class="s1">. Cannot use a variable that had not been declared. Variable: </span><span class="si">{</span><span class="n">ast_node</span><span class="o">.</span><span class="n">transition</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">ReturnNode</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">UserNode</span><span class="p">):</span> 
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;define&#39;</span><span class="p">]]:</span>
                    <span class="k">raise</span> <span class="n">DetailedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Runtime error with the statement </span><span class="si">{</span><span class="n">ast_node</span><span class="si">}</span><span class="s1">. Cannot use a variable that had not been declared. Variable: </span><span class="si">{</span><span class="n">ast_node</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">JumpNode</span><span class="p">):</span>
            <span class="c1"># Getting all the label name that exist (not just the ones that have been stored in self.labels_table)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">label_name</span><span class="p">,</span> <span class="n">UserNode</span><span class="p">):</span> <span class="c1"># We don&#39;t verify when label_name = &#39;start&#39; keyword</span>
                <span class="k">return</span>
            <span class="n">all_label_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast_tree</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">LabelNode</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">label_name</span><span class="p">,</span> <span class="n">UserNode</span><span class="p">):</span> <span class="c1"># ast_node is necessarily a UserNode</span>
                    <span class="n">all_label_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">label_name</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">label_name</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_label_names</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DetailedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Runtime error with the statement </span><span class="si">{</span><span class="n">ast_node</span><span class="si">}</span><span class="s1">. Cannot use a variable that had not been declared. Variable: </span><span class="si">{</span><span class="n">ast_node</span><span class="o">.</span><span class="n">label_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">DialogueNode</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">speaker</span><span class="p">,</span> <span class="n">UserNode</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">speaker</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;define&#39;</span><span class="p">]]:</span>
                    <span class="k">raise</span> <span class="n">DetailedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Runtime error with the statement </span><span class="si">{</span><span class="n">ast_node</span><span class="si">}</span><span class="s1">. Cannot use a variable that had not been declared. Variable: </span><span class="si">{</span><span class="n">ast_node</span><span class="o">.</span><span class="n">speaker</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">speaker</span><span class="p">,</span> <span class="n">FunctionCallNode</span><span class="p">):</span>
                <span class="n">user_node_list</span> <span class="o">=</span> <span class="n">ast_node</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">get_user_tokens</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">user_token</span> <span class="ow">in</span> <span class="n">user_node_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_token</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;define&#39;</span><span class="p">]]:</span>
                        <span class="k">raise</span> <span class="n">DetailedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Runtime error with the statement </span><span class="si">{</span><span class="n">ast_node</span><span class="si">}</span><span class="s1">. Cannot use a variable that had not been declared. Variable: </span><span class="si">{</span><span class="n">user_token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="VisualNovelGenerator.step4_label_body_initialize">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.VisualNovelGenerator.step4_label_body_initialize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">step4_label_body_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ast_label_body</span><span class="p">:</span> <span class="n">LabelNode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Initializes the body of a label, verifying and organizing various AST nodes into their respective categories </span>
<span class="sd">        (e.g., &#39;scene&#39;, &#39;show&#39;, &#39;hide&#39;, &#39;play&#39;, &#39;dialogue&#39;, etc.) within the `labels_table` for further processing.</span>

<span class="sd">        This function performs the following tasks:</span>

<span class="sd">        - Ensures that the label name has not been used previously in the `labels_table`.</span>
<span class="sd">        - Iterates through the AST nodes associated with the label body, verifying prior declarations for each node.</span>
<span class="sd">        - Categorizes and stores nodes like `SceneNode`, `ShowNode`, `HideNode`, `PlayNode`, `StopNode`, `TransitionNode`, </span>
<span class="sd">        `ReturnNode`, `JumpNode`, `DialogueNode`, and `StringNode` into their corresponding sections in the label&#39;s body.</span>
<span class="sd">        - Each section (e.g., &#39;scene&#39;, &#39;show&#39;, &#39;hide&#39;) is populated with a list of relevant AST nodes, and the proper arguments </span>
<span class="sd">        (such as transform, layer, transition) are extracted and stored.</span>
<span class="sd">        - Ensures that the `with` statement, if present, is placed correctly, as it must follow certain other node types </span>
<span class="sd">        (such as `scene`, `show`, or `hide`).</span>

<span class="sd">        Arguments:</span>
<span class="sd">        ----------</span>
<span class="sd">        ast_label_body: The AST node representing the label body to be initialized.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">last_node_added</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># Required only for &#39;with&#39;</span>
        <span class="c1"># Check if label name has not already been used:</span>
        <span class="k">if</span> <span class="n">ast_label_body</span><span class="o">.</span><span class="n">label_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_table</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DetailedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Runtime error. Cannot use a label name twice: </span><span class="si">{</span><span class="n">ast_label_body</span><span class="o">.</span><span class="n">label_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels_table</span><span class="p">[</span><span class="n">ast_label_body</span><span class="o">.</span><span class="n">label_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">label_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_table</span><span class="p">[</span><span class="n">ast_label_body</span><span class="o">.</span><span class="n">label_name</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ast_node</span> <span class="ow">in</span> <span class="n">ast_label_body</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">SceneNode</span><span class="p">):</span> <span class="c1">#Ex: scene eileen happy blushing at center with transition </span>
                <span class="k">if</span> <span class="s1">&#39;scene&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">label_body</span><span class="p">:</span>
                    <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;scene&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Cannot be None by default or we will have an error</span>
                    <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;scene&#39;</span><span class="p">][</span><span class="s1">&#39;masternode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Useful only for &#39;with&#39; statement alone in label body</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">verify_prior_declaration</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span> 
                    <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;layer&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;transition&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;transition&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_nested_table</span><span class="p">(</span><span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;scene&#39;</span><span class="p">],</span> <span class="n">ast_node</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;scene&#39;</span><span class="p">][</span><span class="s1">&#39;masternode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span> 

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">ShowNode</span><span class="p">):</span>  
                <span class="k">if</span> <span class="s1">&#39;show&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">label_body</span><span class="p">:</span>
                    <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Cannot be None by default or we will have an error</span>
                    <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">][</span><span class="s1">&#39;masternode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Useful only for &#39;with&#39; statement alone in label body</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">verify_prior_declaration</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span> 
                    <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;layer&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;transition&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;transition&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_nested_table</span><span class="p">(</span><span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">],</span> <span class="n">ast_node</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">][</span><span class="s1">&#39;masternode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span> 

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">HideNode</span><span class="p">):</span> <span class="c1">#Ex: scene eileen happy blushing at center with transition </span>
                <span class="k">if</span> <span class="s1">&#39;hide&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">label_body</span><span class="p">:</span>
                    <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;hide&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Cannot be None by default or we will have an error</span>
                    <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;hide&#39;</span><span class="p">][</span><span class="s1">&#39;masternode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Useful only for &#39;with&#39; statement alone in label body</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">verify_prior_declaration</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span> 
                    <span class="s1">&#39;layer&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;transition&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;transition&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_nested_table</span><span class="p">(</span><span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;hide&#39;</span><span class="p">],</span> <span class="n">ast_node</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;hide&#39;</span><span class="p">][</span><span class="s1">&#39;masternode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">PlayNode</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;play&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">label_body</span><span class="p">:</span>
                    <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;play&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Cannot be None by default or we will have an error</span>
                
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span> 
                    <span class="s1">&#39;audio_type&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;audio_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;audio_file&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;audio_file&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;fadein&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;fadein&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;loop&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;loop&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;play&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> 

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">StopNode</span><span class="p">):</span> 
                <span class="k">if</span> <span class="s1">&#39;stop&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">label_body</span><span class="p">:</span>
                    <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Cannot be None by default or we will have an error</span>

                <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">TransitionNode</span><span class="p">):</span>  
                <span class="c1"># Must be preceed by &#39;scene&#39;, &#39;show&#39;, &#39;hide&#39;</span>
                <span class="n">node_type</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_node_added</span><span class="p">,</span> <span class="n">SceneNode</span><span class="p">):</span>
                    <span class="n">node_type</span> <span class="o">=</span> <span class="s2">&quot;scene&quot;</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_node_added</span><span class="p">,</span> <span class="n">ShowNode</span><span class="p">):</span>
                    <span class="n">node_type</span> <span class="o">=</span> <span class="s2">&quot;show&quot;</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_node_added</span><span class="p">,</span> <span class="n">HideNode</span><span class="p">):</span>
                    <span class="n">node_type</span> <span class="o">=</span> <span class="s2">&quot;hide&quot;</span>
                <span class="k">if</span> <span class="n">node_type</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DetailedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Runtime error. with statement </span><span class="si">{</span><span class="n">ast_node</span><span class="si">}</span><span class="s1"> must be preceed by either scene, show, hide statement instead of </span><span class="si">{</span><span class="n">last_node_added</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">verify_prior_declaration</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">node_type</span> <span class="o">!=</span> <span class="s1">&#39;hide&#39;</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span> 
                        <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">label_body</span><span class="p">[</span><span class="n">node_type</span><span class="p">][</span><span class="s1">&#39;masternode&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                        <span class="s1">&#39;layer&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">label_body</span><span class="p">[</span><span class="n">node_type</span><span class="p">][</span><span class="s1">&#39;masternode&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                        <span class="s1">&#39;transition&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;transition&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span> 
                        <span class="s1">&#39;layer&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;hide&#39;</span><span class="p">][</span><span class="s1">&#39;masternode&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                        <span class="s1">&#39;transition&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;transition&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_nested_table</span><span class="p">(</span><span class="n">label_body</span><span class="p">[</span><span class="n">node_type</span><span class="p">],</span> <span class="n">label_body</span><span class="p">[</span><span class="n">node_type</span><span class="p">][</span><span class="s1">&#39;masternode&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">StringNode</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;string&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">label_body</span><span class="p">:</span>
                    <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Cannot be None by default or we will have an error</span>

                <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;string&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">ReturnNode</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;return&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">label_body</span><span class="p">:</span>
                    <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Cannot be None by default or we will have an error</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">verify_prior_declaration</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span>
                <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> 

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">JumpNode</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;jump&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">label_body</span><span class="p">:</span>
                    <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;jump&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Cannot be None by default or we will have an error</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">verify_prior_declaration</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span>
                <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;jump&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">label_name</span><span class="p">)</span> 

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">DialogueNode</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;dialogue&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">label_body</span><span class="p">:</span>
                    <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;dialogue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Cannot be None by default or we will have an error</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">verify_prior_declaration</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span>
                <span class="n">label_body</span><span class="p">[</span><span class="s1">&#39;dialogue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span>

            <span class="n">last_node_added</span> <span class="o">=</span> <span class="n">ast_node</span></div>

          
<div class="viewcode-block" id="VisualNovelGenerator.step4_initialize_master_node">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.VisualNovelGenerator.step4_initialize_master_node">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">step4_initialize_master_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Initializes the master node by processing the AST tree and storing the corresponding statements in the symbol table.</span>

<span class="sd">        This function performs the following tasks:</span>

<span class="sd">        - Iterates through the AST tree to process various types of nodes (`DefineNode`, `ImageNode`, `SceneNode`, `ShowNode`, `HideNode`, </span>
<span class="sd">        `PlayNode`, `StopNode`, `LabelNode`).</span>
<span class="sd">        - For each node, it verifies prior declarations using the `verify_prior_declaration` method to ensure that any referenced tags, </span>
<span class="sd">        variables, or functions have been declared before use.</span>
<span class="sd">        - Adds each processed node to the relevant section of the `symbols_table`:</span>
<span class="sd">        - `DefineNode`: Stores the variable or function definition.</span>
<span class="sd">        - `ImageNode`: Stores image expressions.</span>
<span class="sd">        - `SceneNode`, `ShowNode`, `HideNode`: Stores scene-related data, including transformation, layer, and transition attributes.</span>
<span class="sd">        - `PlayNode`, `StopNode`: Stores play and stop instructions.</span>
<span class="sd">        - `LabelNode`: Processes labels and delegates further initialization to the `step4_label_body_initialize` method for label body processing.</span>
<span class="sd">        </span>
<span class="sd">        Arguments:</span>
<span class="sd">        ----------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Goal: Store all statements in a symbol node and check if a statement (whether inside a label or outside) is used before being initialised</span>
        <span class="k">for</span> <span class="n">ast_node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast_tree</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">DefineNode</span><span class="p">):</span> <span class="c1"># We are declaring a variable, no need to check if it&#39;s used before initialised </span>
                <span class="k">if</span> <span class="s1">&#39;define&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;define&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Cannot be None by default or we will have an error</span>

                <span class="c1"># Before adding to symbols_table we check if the USER tokens used on right side of ASSIGN (&#39;=&#39;) are declared or not. </span>
                <span class="c1"># ast_node can be either a FunctionNode, User token or a string (we don&#39;t check if it&#39;s a string)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verify_prior_declaration</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span>

                <span class="c1"># We add it to symbols_table</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;define&#39;</span><span class="p">][</span><span class="n">ast_node</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">ast_node</span><span class="o">.</span><span class="n">value</span> <span class="c1"># Define statement is now considered &#39;initialised&#39;</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">ImageNode</span><span class="p">):</span> <span class="c1"># Ex: ast_node.image_expression = [&#39;eileen&#39;, &#39;happy&#39;, &#39;blushing&#39;]</span>
                <span class="k">if</span> <span class="s1">&#39;image&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Cannot be None by default or we will have an error</span>

                <span class="n">img_path</span> <span class="o">=</span> <span class="n">ast_node</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">update_nested_table_image_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">],</span> <span class="n">ast_node</span><span class="p">,</span> <span class="n">img_path</span><span class="p">)</span> <span class="c1"># image statement is now considered &#39;initialised&#39;</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">SceneNode</span><span class="p">):</span> <span class="c1">#Ex: scene eileen happy blushing at center with transition </span>
                <span class="k">if</span> <span class="s1">&#39;scene&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;scene&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Cannot be None by default or we will have an error</span>

                <span class="c1"># Before adding to symbols_table we check if the tags used used are declared or not. </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verify_prior_declaration</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span>

                <span class="c1"># We add it to symbols_table</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span> 
                    <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;layer&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;transition&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;transition&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">}</span>

                <span class="c1"># Regarding transition, to simplify this project we simply don&#39;t handle them.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_nested_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;scene&#39;</span><span class="p">],</span> <span class="n">ast_node</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">ShowNode</span><span class="p">):</span>  
                <span class="k">if</span> <span class="s1">&#39;show&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Cannot be None by default or we will have an error</span>
                
                <span class="c1"># Before adding to symbols_table we check if the tags used used are declared or not. </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verify_prior_declaration</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span>

                <span class="c1"># We add it to symbols_table</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span> 
                    <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;layer&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;transition&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;transition&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_nested_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">],</span> <span class="n">ast_node</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">HideNode</span><span class="p">):</span> <span class="c1">#Ex: scene eileen happy blushing at center with transition </span>
                <span class="k">if</span> <span class="s1">&#39;hide&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;hide&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Cannot be None by default or we will have an error</span>

                <span class="c1"># Before adding to symbols_table we check if the tags used used are declared or not. </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verify_prior_declaration</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span>

                <span class="c1"># We add it to symbols_table</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span> 
                    <span class="s1">&#39;layer&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;transition&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="s2">&quot;transition&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_nested_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;hide&#39;</span><span class="p">],</span> <span class="n">ast_node</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">PlayNode</span><span class="p">):</span> <span class="c1">#Ex: scene eileen happy blushing at center with transition </span>
                <span class="k">if</span> <span class="s1">&#39;play&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;play&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Cannot be None by default or we will have an error</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;play&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span> 

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">StopNode</span><span class="p">):</span> <span class="c1">#Ex: scene eileen happy blushing at center with transition </span>
                <span class="k">if</span> <span class="s1">&#39;stop&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Cannot be None by default or we will have an error</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">LabelNode</span><span class="p">):</span> <span class="c1">#Ex: scene eileen happy blushing at center with transition </span>
                <span class="c1"># We need to go through label body to see if anything requires initialisation</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">step4_label_body_initialize</span><span class="p">(</span><span class="n">ast_node</span><span class="p">)</span></div>


<div class="viewcode-block" id="VisualNovelGenerator.step5_runtime">
<a class="viewcode-back" href="../visualnovel.html#visualnovel.VisualNovelGenerator.step5_runtime">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">step5_runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        -----------</span>
<span class="sd">        Runs the visual novel by initializing the state machine and generating the game.</span>

<span class="sd">        This function performs the following tasks:</span>
<span class="sd">        - Initializes a `StateMachine` using the current `symbols_table`, `labels_table`, `ast_tree`, and the path to the Ren&#39;Py file.</span>
<span class="sd">        - Calls the `generate_VN` method of the `StateMachine` to start the execution of the visual novel.</span>
<span class="sd">        - The `generate_VN` method is responsible for processing and rendering the visual novel, including the handling of debug mode if enabled.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        ----------</span>
<span class="sd">        None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sM</span> <span class="o">=</span> <span class="n">StateMachine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast_tree</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_to_renpyfile</span><span class="p">)</span>
        <span class="n">sM</span><span class="o">.</span><span class="n">generate_VN</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, David J.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>